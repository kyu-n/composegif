name: Build Release

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:

jobs:
    build-windows:
        runs-on: windows-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v3

            - name: Set JRE_TARGET environment variable
              run: echo "JRE_TARGET=$env:JAVA_HOME" >> $env:GITHUB_ENV
              shell: powershell

            - name: Build with Gradle
              run: ./gradlew :app:dist

            - name: Create distribution package
              run: |
                  New-Item -ItemType Directory -Force -Path dist-package
                  Copy-Item -Path app/build/runtime -Destination dist-package/runtime -Recurse
                  Copy-Item -Path app/build/libs/composegif.jar -Destination dist-package/

                  # Create batch file launcher
                  @"
                  @echo off
                  start "" /B "%~dp0runtime\bin\javaw" -Xmx256m -XX:+UseZGC -Dsun.java2d.opengl=true -jar "%~dp0composegif.jar" %*
                  exit
                  "@ | Out-File -FilePath dist-package/composegif.bat -Encoding ASCII

                  # Zip the package
                  Compress-Archive -Path dist-package/* -DestinationPath composegif-windows-${{ github.ref_name }}.zip
              shell: powershell

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: composegif-windows
                  path: composegif-windows-${{ github.ref_name }}.zip
                  retention-days: 90

            - name: Create Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v2
              with:
                  files: composegif-windows-${{ github.ref_name }}.zip
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  token: ${{ secrets.GITHUB_TOKEN }}